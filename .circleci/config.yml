version: 2.1

executors:
  node22:
    docker:
      - image: cimg/node:22.16
    working_directory: ~/app

jobs:
  build_and_push:
    executor: node22
    steps:
      - checkout
      - run:
          name: Clone front-end source code
          command: |
            git clone https://github.com/HAIZAKURA/mytools-vue.git
      - run:
          name: Install pnpm package manager
          command: |
            cd ./mytools-vue
            npm install --global corepack@latest
            corepack enable
            corepack prepare pnpm@latest-10 --activate
            pnpm config set store-dir .pnpm-store
      - run:
          name: Install Dependencies and Build
          command: |
            cd ./mytools-vue
            pnpm install
            pnpm run build
      - run:
          name: Move front-end build files
          command: |
            mv ./mytools-vue/dist ../public
      - run:
          name: Delete front-end source code
          command: |
            rm -rf mytools-vue
      - setup_remote_docker
      - run:
          name: Login to Docker Hub
          command: |
            echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
      - run:
          name: Build Docker image
          command: |
            TAG=3.0.$CIRCLE_BUILD_NUM
            docker build -t $DOCKERHUB_USERNAME/mytools-vue:$TAG .
      - run:
          name: Push Docker image
          command: |
            TAG=3.0.$CIRCLE_BUILD_NUM
            docker push $DOCKERHUB_USERNAME/mytools-vue:$TAG

workflows:
  build_and_deploy:
    jobs:
      - build_and_push
